ARG ACCOUNT_ID=864899869769
ARG REGION=us-east-1
ARG LIBREOFFICE_REPO=aytanai-batch-process-libreoffice

FROM ${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/${LIBREOFFICE_REPO}:latest AS libreoffice


FROM public.ecr.aws/lambda/python:3.12


# Copy LibreOffice binaries, libraries, fonts, and configuration
COPY --from=libreoffice /opt/libreoffice25.2 /opt/libreoffice25.2
COPY --from=libreoffice /usr/share/fonts /usr/share/fonts
COPY --from=libreoffice /usr/share/libreoffice /usr/share/libreoffice
COPY --from=libreoffice /opt/libreoffice25.2/program/oosplash /opt/libreoffice25.2/program/oosplash

RUN dnf -y install findutils
RUN dnf -y install fontconfig

# Copy LibreOffice shared libraries to a dedicated directory
RUN mkdir -p /usr/lib64/libreoffice && \
    find /opt/libreoffice25.2 -name '*.so*' -exec cp -n {} /usr/lib64/libreoffice/ \; && \
    /sbin/ldconfig

# Verify library presence
RUN echo "Checking for required libraries..." && \
    find /usr/lib64 -name 'libssl3.so' || echo "libssl3.so not found" && \
    find /usr/lib64 -name 'libtiff.so.5' || echo "libtiff.so.5 not found" && \
    find /usr/local/lib -name 'libtiff.so.5' || echo "libtiff.so.5 not found in /usr/local/lib"

# Initialize font cache and ensure permissions
RUN fc-cache -f && \
    chmod -R 755 /opt/libreoffice25.2 /usr/share/libreoffice && \
    mkdir -p /tmp/libreoffice && \
    chmod -R 777 /tmp/libreoffice

# Verify font and registry files
RUN ls -l /usr/share/libreoffice/registry && \
    fc-list | grep -i liberation && \
    fc-cache -f

RUN ls -lart /opt/libreoffice25.2/program/oosplash
RUN ls -lart /usr/lib64

# Set environment variables
ENV LD_LIBRARY_PATH=/usr/lib64:/usr/lib64/libreoffice:/usr/local/lib:/opt/libreoffice25.2/program:/opt/libreoffice25.2/ure/lib:$LD_LIBRARY_PATH \
    PATH=/opt/libreoffice25.2/program:/usr/local/bin:$PATH \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8 \
    HOME=/tmp \
    LIBREOFFICE_HOME=/opt/libreoffice25.2 \
    XDG_DATA_HOME=/tmp/libreoffice \
    XDG_CONFIG_HOME=/tmp/libreoffice \
    JAVA_HOME=/usr/lib64/jvm/java-17-amazon-corretto

# Copy Lambda handler
COPY lambda_function.py .

# Define Lambda entrypoint
CMD ["lambda_function.lambda_handler"]

