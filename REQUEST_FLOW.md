# Request Flow - Document Upload & RAG Query

## ğŸ“„ DOCUMENT UPLOAD FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLIENT    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. Request presigned URL
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway                         â”‚
â”‚  /presigned-url                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Forward to Lambda
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Lambda Function                    â”‚
â”‚  (presigned_url.py)                 â”‚
â”‚  - Generate S3 presigned URL        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Return presigned URL
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLIENT    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. Upload file directly to S3
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AWS S3 Bucket                      â”‚
â”‚  - Store uploaded document           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 5. Trigger event
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Lambda Function                    â”‚
â”‚  (document_processor.py)            â”‚
â”‚  - Receives S3 event                â”‚
â”‚  - Extracts bucket & key            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 6. Call ECS /process endpoint
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Load Balancer (ALB)     â”‚
â”‚  - Routes traffic to ECS tasks        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 7. Forward to ECS task
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ECS Fargate Task (RAG Client)      â”‚
â”‚  POST /process                       â”‚
â”‚                                      â”‚
â”‚  â”œâ”€ Parse request data              â”‚
â”‚  â”œâ”€ Extract s3_bucket, s3_key       â”‚
â”‚  â”œâ”€ Submit to ThreadPoolExecutor     â”‚
â”‚  â””â”€ Return immediately:              â”‚
â”‚     {                                â”‚
â”‚       "status": "accepted",          â”‚
â”‚       "message": "processing...",    â”‚
â”‚       "bucket": "...",               â”‚
â”‚       "key": "..."                    â”‚
â”‚     }                                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 8. HTTP 200 Response
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLIENT    â”‚ â† Receives immediate response
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BACKGROUND THREAD (ThreadPoolExecutor)  â”‚
â”‚  process_document_background()          â”‚
â”‚                                          â”‚
â”‚  Step 1: Download from S3               â”‚
â”‚  â”œâ”€ Connect to S3 client               â”‚
â”‚  â”œâ”€ Download file to /tmp/             â”‚
â”‚  â””â”€ Log file size                      â”‚
â”‚                                          â”‚
â”‚  Step 2: Get RAG Instance               â”‚
â”‚  â”œâ”€ Call get_rag_instance()            â”‚
â”‚  â””â”€ Return RAGAnything instance         â”‚
â”‚                                          â”‚
â”‚  Step 3: Parse Document                  â”‚
â”‚  â”œâ”€ Call rag.parse_document()           â”‚
â”‚  â”œâ”€ Parse with Docling (OCR)            â”‚
â”‚  â””â”€ Return structured elements          â”‚
â”‚                                          â”‚
â”‚  Step 4: Extract Chunks                 â”‚
â”‚  â”œâ”€ Check USE_LLM_CHUNKING flag        â”‚
â”‚  â”‚                                      â”‚
â”‚  â”œâ”€ IF LLM_CHUNKING=true:              â”‚
â”‚  â”‚  â”œâ”€ Convert to markdown              â”‚
â”‚  â”‚  â”œâ”€ Call custom_llm_chunking()       â”‚
â”‚  â”‚  â””â”€ GPT-4o-mini chunks content       â”‚
â”‚  â”‚                                      â”‚
â”‚  â””â”€ ELSE (default):                    â”‚
â”‚     â”œâ”€ Extract native Docling chunks   â”‚
â”‚     â””â”€ Fast text-based extraction       â”‚
â”‚                                          â”‚
â”‚  Step 5: Insert into LightRAG           â”‚
â”‚  â”œâ”€ Call rag.insert_content_list()     â”‚
â”‚  â”œâ”€ Insert chunks into vector store    â”‚
â”‚  â”œâ”€ Generate embeddings                â”‚
â”‚  â””â”€ Store on EFS                       â”‚
â”‚                                          â”‚
â”‚  Cleanup:                               â”‚
â”‚  â””â”€ Delete temp file                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” RAG QUERY FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLIENT    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. POST /query
       â”‚    {
       â”‚      "query": "What is...?",
       â”‚      "mode": "hybrid"
       â”‚    }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway                         â”‚
â”‚  POST /rag-query                     â”‚
â”‚  - 30s timeout                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Forward to Lambda
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Lambda Function                    â”‚
â”‚  (rag_query.py)                     â”‚
â”‚  - Parse request                     â”‚
â”‚  - Extract query & mode              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Call ECS /query
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Load Balancer (ALB)     â”‚
â”‚  - Routes to ECS tasks                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. Forward to ECS task
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ECS Fargate Task (RAG Client)      â”‚
â”‚  POST /query                         â”‚
â”‚                                      â”‚
â”‚  Step 1: Parse Request              â”‚
â”‚  â”œâ”€ Extract query & mode            â”‚
â”‚  â””â”€ Validate input                  â”‚
â”‚                                      â”‚
â”‚  Step 2: Get RAG Instance            â”‚
â”‚  â”œâ”€ Call get_rag_instance()         â”‚
â”‚  â””â”€ Return cached or new instance   â”‚
â”‚                                      â”‚
â”‚  Step 3: Execute Query               â”‚
â”‚  â”œâ”€ Call rag.aquery(query, mode)    â”‚
â”‚  â”‚                                   â”‚
â”‚  â”œâ”€ IF mode="hybrid":               â”‚
â”‚  â”‚  â”œâ”€ Hybrid RAG (embedding + KG)  â”‚
â”‚  â”‚  â””â”€ Returns answer + sources      â”‚
â”‚  â”‚                                   â”‚
â”‚  â”œâ”€ IF mode="naive":                â”‚
â”‚  â”‚  â”œâ”€ Naive RAG (embedding only)   â”‚
â”‚  â”‚  â””â”€ Returns answer + sources     â”‚
â”‚  â”‚                                   â”‚
â”‚  â””â”€ IF mode="local":                â”‚
â”‚     â”œâ”€ Local RAG (KG only)          â”‚
â”‚     â””â”€ Returns answer + sources      â”‚
â”‚                                      â”‚
â”‚  Step 4: Parse Result                â”‚
â”‚  â”œâ”€ Extract answer                   â”‚
â”‚  â”œâ”€ Extract sources                  â”‚
â”‚  â”œâ”€ Extract confidence               â”‚
â”‚  â””â”€ Format response                  â”‚
â”‚                                      â”‚
â”‚  Return:                             â”‚
â”‚  {                                   â”‚
â”‚    "query": "...",                   â”‚
â”‚    "answer": "...",                  â”‚
â”‚    "sources": [...],                 â”‚
â”‚    "confidence": 0.95,               â”‚
â”‚    "mode": "hybrid",                 â”‚
â”‚    "status": "completed",            â”‚
â”‚    "timing": {                       â”‚
â”‚      "query_duration": 2.34,        â”‚
â”‚      "parse_duration": 0.01,        â”‚
â”‚      "total_duration": 2.35         â”‚
â”‚    }                                  â”‚
â”‚  }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 5. HTTP 200 Response
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLIENT    â”‚ â† Receives answer
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UNDER THE HOOD (LightRAG)               â”‚
â”‚                                          â”‚
â”‚  When rag.aquery() is called:           â”‚
â”‚                                          â”‚
â”‚  1. Embedding Lookup                     â”‚
â”‚     â”œâ”€ Generate query embedding         â”‚
â”‚     â”œâ”€ Search vector store (EFS)        â”‚
â”‚     â””â”€ Find top-k similar chunks        â”‚
â”‚                                          â”‚
â”‚  2. Knowledge Graph Lookup             â”‚
â”‚     â”œâ”€ Query KG for related entities    â”‚
â”‚     â”œâ”€ Traverse relationships           â”‚
â”‚     â””â”€ Extract context                  â”‚
â”‚                                          â”‚
â”‚  3. Context Assembly                    â”‚
â”‚     â”œâ”€ Combine relevant chunks          â”‚
â”‚     â”œâ”€ Add KG context                   â”‚
â”‚     â””â”€ Format for LLM                   â”‚
â”‚                                          â”‚
â”‚  4. LLM Generation                      â”‚
â”‚     â”œâ”€ Send prompt + context to GPT     â”‚
â”‚     â”œâ”€ Generate answer                  â”‚
â”‚     â”œâ”€ Extract sources                  â”‚
â”‚     â””â”€ Return to client                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ COMPONENT INTERACTIONS

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CLIENT    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
        â–¼                  â–¼                  â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Upload  â”‚      â”‚  Query  â”‚      â”‚Health   â”‚
   â”‚ Flow    â”‚      â”‚  Flow   â”‚      â”‚ Check   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API       â”‚    â”‚   API       â”‚   â”‚   API       â”‚
â”‚  Gateway    â”‚    â”‚  Gateway    â”‚   â”‚  Gateway    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                 â”‚
       â–¼                  â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Lambda     â”‚    â”‚  Lambda     â”‚   â”‚  Lambda     â”‚
â”‚ (presigned  â”‚    â”‚ (rag_query   â”‚   â”‚ (health     â”‚
â”‚   _url)     â”‚    â”‚   .py)      â”‚   â”‚   .py)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                 â”‚
       â–¼                  â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     S3      â”‚    â”‚     ALB     â”‚   â”‚     ALB     â”‚
â”‚   Storage   â”‚    â”‚             â”‚   â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                 â”‚
       â–¼                  â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Lambda    â”‚    â”‚   ECS       â”‚   â”‚   ECS       â”‚
â”‚(processor)  â”‚    â”‚  Fargate    â”‚   â”‚  Fargate    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                 â”‚
       â–¼                  â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ALB     â”‚    â”‚    RAG      â”‚   â”‚     RAG     â”‚
â”‚             â”‚    â”‚  Client     â”‚   â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                 â”‚
       â–¼                  â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ECS       â”‚    â”‚  LightRAG   â”‚   â”‚  LightRAG   â”‚
â”‚  Fargate    â”‚    â”‚             â”‚   â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                 â”‚
       â–¼                  â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RAG       â”‚    â”‚     EFS     â”‚   â”‚     EFS     â”‚
â”‚  Client     â”‚    â”‚  (Storage)  â”‚   â”‚  (Storage)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š STORAGE LAYERS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EFS (Elastic File System)               â”‚
â”‚  - Persistent storage across ECS tasks    â”‚
â”‚  - Shared across all task instances       â”‚
â”‚                                            â”‚
â”‚  Structure:                                â”‚
â”‚  /rag-output/                              â”‚
â”‚    â”œâ”€â”€ chunks/                             â”‚
â”‚    â”‚   â””â”€â”€ embeddings.json                 â”‚
â”‚    â”œâ”€â”€ kg/                                 â”‚
â”‚    â”‚   â”œâ”€â”€ entities.json                   â”‚
â”‚    â”‚   â”œâ”€â”€ relations.json                  â”‚
â”‚    â”‚   â””â”€â”€ metadata.json                   â”‚
â”‚    â””â”€â”€ status/                             â”‚
â”‚        â””â”€â”€ pipeline_status.json             â”‚
â”‚                                            â”‚
â”‚  Data Flow:                                â”‚
â”‚  1. Document processed â†’ Chunks saved     â”‚
â”‚  2. Embeddings generated â†’ Stored in EFS  â”‚
â”‚  3. Knowledge Graph built â†’ Stored in EFS â”‚
â”‚  4. Query â†’ Reads from EFS                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ KEY ENDPOINTS

### Document Upload
- **GET /presigned-url** â†’ Get S3 upload URL
- **POST /process** â†’ Trigger document processing (returns immediately)
- **Background**: Download â†’ Parse â†’ Chunk â†’ Insert

### RAG Query  
- **POST /query** â†’ Query RAG system (returns answer + sources)
- **POST /health** â†’ Check ECS task status

### Processing Steps
1. S3 Download âœ…
2. RAG Instance âœ…
3. Document Parsing âœ…
4. Chunk Extraction âœ…
5. Data Insertion âœ…

