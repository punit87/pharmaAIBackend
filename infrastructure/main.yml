AWSTemplateFormatVersion: '2010-09-09'
Description: 'Main CloudFormation template for Pharma RAG system - orchestrates all modules'

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, dev-1, dev-2, staging, prod]
    Description: Environment name

  RaganythingImageUri:
    Type: String
    Description: RAG-Anything Docker image URI

  OpenAIApiKey:
    Type: String
    NoEcho: true
    Description: OpenAI API Key

  Neo4jUri:
    Type: String
    Description: Neo4j URI

  Neo4jUsername:
    Type: String
    Description: Neo4j Username

  Neo4jPassword:
    Type: String
    NoEcho: true
    Description: Neo4j Password

  S3Bucket:
    Type: String
    Description: S3 bucket for CloudFormation templates and Lambda packages

Resources:
  # Network Infrastructure
  NetworkStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${S3Bucket}.s3.${AWS::Region}.amazonaws.com/cloudformation-templates/network.yml'
      Parameters:
        Environment: !Ref Environment

  # Storage Infrastructure
  StorageStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${S3Bucket}.s3.${AWS::Region}.amazonaws.com/cloudformation-templates/storage.yml'
      Parameters:
        Environment: !Ref Environment


  # ECS Infrastructure
  ECSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${S3Bucket}.s3.${AWS::Region}.amazonaws.com/cloudformation-templates/ecs.yml'
      Parameters:
        Environment: !Ref Environment
        VPCId: !GetAtt NetworkStack.Outputs.VPCId
        PublicSubnet1: !GetAtt NetworkStack.Outputs.PublicSubnet1
        PublicSubnet2: !GetAtt NetworkStack.Outputs.PublicSubnet2
        PrivateSubnet1: !GetAtt NetworkStack.Outputs.PrivateSubnet1
        PrivateSubnet2: !GetAtt NetworkStack.Outputs.PrivateSubnet2
        ALBSecurityGroup: !GetAtt NetworkStack.Outputs.ALBSecurityGroup
        ECSSecurityGroup: !GetAtt NetworkStack.Outputs.ECSSecurityGroup
        RaganythingImageUri: !Ref RaganythingImageUri
        OpenAIApiKey: !Ref OpenAIApiKey
        Neo4jUri: !Ref Neo4jUri
        Neo4jUsername: !Ref Neo4jUsername
        Neo4jPassword: !Ref Neo4jPassword
        DocumentBucket: !GetAtt StorageStack.Outputs.DocumentBucketName

  # Lambda Functions
  LambdaStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${S3Bucket}.s3.${AWS::Region}.amazonaws.com/cloudformation-templates/lambda.yml'
      Parameters:
        Environment: !Ref Environment
        VPCId: !GetAtt NetworkStack.Outputs.VPCId
        PublicSubnet1: !GetAtt NetworkStack.Outputs.PublicSubnet1
        PublicSubnet2: !GetAtt NetworkStack.Outputs.PublicSubnet2
        LambdaSecurityGroup: !GetAtt NetworkStack.Outputs.LambdaSecurityGroup
        ECSCluster: !GetAtt ECSStack.Outputs.ECSCluster
        RaganythingTaskDefinition: !GetAtt ECSStack.Outputs.RaganythingTaskDefinition
        ECSSecurityGroup: !GetAtt NetworkStack.Outputs.ECSSecurityGroup
        ALBEndpoint: !GetAtt ECSStack.Outputs.ALBEndpoint
        DocumentBucket: !GetAtt StorageStack.Outputs.DocumentBucketName
        S3Bucket: !Ref S3Bucket
        Neo4jUri: !Ref Neo4jUri
        Neo4jUsername: !Ref Neo4jUsername
        Neo4jPassword: !Ref Neo4jPassword
        DocumentBucket: !GetAtt StorageStack.Outputs.DocumentBucketName

  # API Gateway
  ApiGatewayStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: 
      - NetworkStack
      - ECSStack
    Properties:
      TemplateURL: !Sub 'https://${S3Bucket}.s3.${AWS::Region}.amazonaws.com/cloudformation-templates/api-gateway.yml'
      Parameters:
        Environment: !Ref Environment
        VPCId: !GetAtt NetworkStack.Outputs.VPCId
        PublicSubnet1: !GetAtt NetworkStack.Outputs.PublicSubnet1
        PublicSubnet2: !GetAtt NetworkStack.Outputs.PublicSubnet2
        ALBDnsName: !GetAtt ECSStack.Outputs.ALBEndpoint

  # WebSocket API
  WebSocketStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - ECSStack
    Properties:
      TemplateURL: !Sub 'https://${S3Bucket}.s3.${AWS::Region}.amazonaws.com/cloudformation-templates/websocket.yml'
      Parameters:
        Environment: !Ref Environment
        ALBEndpoint: !GetAtt ECSStack.Outputs.ALBEndpoint
        DocumentBucket: !GetAtt StorageStack.Outputs.DocumentBucketName


Outputs:
  ApiGatewayUrl:
    Description: API Gateway URL
    Value: !GetAtt ApiGatewayStack.Outputs.ApiGatewayUrl
    Export:
      Name: !Sub '${AWS::StackName}-ApiGatewayUrl'

  WebSocketEndpoint:
    Description: WebSocket API Endpoint
    Value: !GetAtt WebSocketStack.Outputs.WebSocketApiEndpoint
    Export:
      Name: !Sub '${AWS::StackName}-WebSocketEndpoint'

  WebSocketConnectionsTable:
    Description: WebSocket Connections Table Name
    Value: !GetAtt WebSocketStack.Outputs.WebSocketConnectionsTable
    Export:
      Name: !Sub '${AWS::StackName}-WebSocketConnectionsTable'

  DocumentBucketName:
    Description: S3 Bucket for document storage
    Value: !GetAtt StorageStack.Outputs.DocumentBucketName
    Export:
      Name: !Sub '${AWS::StackName}-DocumentBucketName'

  VPCId:
    Description: VPC ID
    Value: !GetAtt NetworkStack.Outputs.VPCId
    Export:
      Name: !Sub '${AWS::StackName}-VPCId'

  ECSClusterName:
    Description: ECS Cluster Name
    Value: !GetAtt ECSStack.Outputs.ECSCluster
    Export:
      Name: !Sub '${AWS::StackName}-ECSClusterName'

  ALBEndpoint:
    Description: ALB DNS Name
    Value: !GetAtt ECSStack.Outputs.ALBEndpoint
    Export:
      Name: !Sub '${AWS::StackName}-ALBEndpoint'

  RaganythingRepositoryUri:
    Description: ECR Repository URI for RAG-Anything
    Value: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/pharma-raganything-${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-RaganythingRepositoryUri'
