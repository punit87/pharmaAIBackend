name: ðŸš€ Build Tesseract and Docling Lambda Images
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  TESSERACT_IMAGE: punit87/tesseract-lambda
  DOCLING_IMAGE: punit87/docling-lambda

jobs:
  build-tesseract-lambda:
    name: ðŸ› ï¸ Build Tesseract OCR Lambda Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ðŸ” Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ³ Build and Push Tesseract Lambda Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.tesseract
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.TESSERACT_IMAGE }}:latest
            ${{ env.REGISTRY }}/${{ env.TESSERACT_IMAGE }}:${{ github.ref_name }}
            ${{ env.REGISTRY }}/${{ env.TESSERACT_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-docling-lambda:
    name: ðŸ› ï¸ Build Docling Lambda Image
    runs-on: ubuntu-latest
    needs: build-tesseract-lambda
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ðŸ” Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ³ Build and Push Docling Lambda Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.docling
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.DOCLING_IMAGE }}:latest
            ${{ env.REGISTRY }}/${{ env.DOCLING_IMAGE }}:${{ github.ref_name }}
            ${{ env.REGISTRY }}/${{ env.DOCLING_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
  summary:
    name: ðŸ§¾ Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-tesseract-lambda, build-docling-lambda]
    if: always()
    steps:
      - name: ðŸª¶ Write Deployment Summary
        run: |
          {
            echo "## ðŸš€ Tesseract and Docling Lambda Images Built Successfully"
            echo ""
            echo "### ðŸŽ¯ Images Built"
            echo "#### Tesseract OCR Image"
            echo "- **Registry**: \`${{ env.REGISTRY }}/${{ env.TESSERACT_IMAGE }}\`"
            echo "- **Tags**: \`latest\`, \`${{ github.ref_name }}\`, \`${{ github.sha }}\`"
            echo ""
            echo "#### Docling Document Processing Image"
            echo "- **Registry**: \`${{ env.REGISTRY }}/${{ env.DOCLING_IMAGE }}\`"
            echo "- **Tags**: \`latest\`, \`${{ github.ref_name }}\`, \`${{ github.sha }}\`"
            echo "- **Architecture**: linux/amd64"
            echo "- **Platform**: AWS Lambda (Container Images)"
            echo ""
            echo "### âœ¨ Features"
            echo "#### Tesseract Image"
            echo "- âœ… Pre-built Tesseract OCR from tesseractshadow/tesseract4re"
            echo "- âœ… English language pack included"
            echo "- âœ… Organized directory structure for multi-stage copying"
            echo "- âœ… Environment variables configured"
            echo ""
            echo "#### Docling Image"
            echo "- âœ… Docling document processing with pip install"
            echo "- âœ… Tesseract OCR integration imported from Tesseract image"
            echo "- âœ… Comprehensive Lambda handler with chunking strategies"
            echo "- âœ… Support for all document types (PDF, DOCX, PPTX, etc.)"
            echo "- âœ… Multiple chunking strategies (sentence, paragraph, table-aware)"
            echo ""
            echo "### ðŸš€ Usage"
            echo "\`\`\`bash"
            echo "# Pull the Docling image (includes Tesseract)"
            echo "docker pull ${{ env.REGISTRY }}/${{ env.DOCLING_IMAGE }}:latest"
            echo ""
            echo "# Test locally"
            echo "docker run --rm ${{ env.REGISTRY }}/${{ env.DOCLING_IMAGE }}:latest"
            echo "\`\`\`"
            echo ""
            echo "### ðŸ“ Next Steps"
            echo "1. **Deploy to Lambda**: Use the Docling image for AWS Lambda"
            echo "2. **Configure S3**: Set up S3 triggers for document processing"
            echo "3. **Test Document Processing**: Upload various document types"
            echo "4. **Use Chunking Strategies**: Configure different chunking approaches"
          } >> $GITHUB_STEP_SUMMARY