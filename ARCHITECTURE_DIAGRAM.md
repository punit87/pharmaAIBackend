# AWS Pharma RAG System Architecture
# ======================================

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    INTERNET                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            │
                                            │ HTTPS/HTTP
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    API GATEWAY                                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   /health       │  │ /presigned-url  │  │   /rag-query    │  │/rag-query-     │            │
│  │     GET         │  │     GET         │  │     POST        │  │multimodal      │            │
│  │                 │  │                 │  │                 │  │    POST        │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            │
                                            │ Lambda Invoke
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    LAMBDA FUNCTIONS                                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   health.py     │  │ presigned_url.py│  │   rag_query.py  │  │rag_query_       │            │
│  │                 │  │                 │  │                 │  │multimodal.py    │            │
│  │ • Check ECS     │  │ • Generate S3   │  │ • Start ECS     │  │ • Start ECS     │            │
│  │   task status   │  │   presigned URL │  │   task          │  │   task          │            │
│  │                 │  │                 │  │ • Call ALB      │  │ • Call ALB      │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            │
                                            │ HTTP Request to ALB
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              APPLICATION LOAD BALANCER (ALB)                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                        Target Group: pharma-ecs-tg-dev-v2                             │    │
│  │  • Health Check: /health                                                              │    │
│  │  • Port: 8000                                                                         │    │
│  │  • Protocol: HTTP                                                                     │    │
│  │  • Grace Period: 60s                                                                  │    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            │
                                            │ HTTP Forward
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    ECS CLUSTER                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                        ECS Service: pharma-raganything-service-dev                     │    │
│  │  • Desired Count: 0 (scales on demand)                                                │    │
│  │  • Launch Type: FARGATE                                                                │    │
│  │  • Auto-registers with ALB Target Group                                               │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                            │                                                  │
│                                            │ Task Registration                               │
│                                            ▼                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                        ECS TASK: RAG-Anything Container                              │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │ Container: raganything                                                      │    │    │
│  │  │ • Image: ECR Repository                                                     │    │    │
│  │  │ • Port: 8000                                                                │    │    │
│  │  │ • CPU: 4096                                                                 │    │    │
│  │  │ • Memory: 8192 MB                                                           │    │    │
│  │  │ • Health Check: curl -f http://localhost:8000/health                        │    │    │
│  │  │                                                                             │    │    │
│  │  │ Environment Variables:                                                      │    │    │
│  │  │ • OPENAI_API_KEY                                                            │    │    │
│  │  │ • NEO4J_URI                                                                 │    │    │
│  │  │ • NEO4J_USERNAME                                                            │    │    │
│  │  │ • NEO4J_PASSWORD                                                            │    │    │
│  │  │ • EFS_MOUNT_PATH: /mnt/efs                                                  │    │    │
│  │  │ • RAG_OUTPUT_DIR: /mnt/efs/rag_output                                       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            │
                                            │ Mount
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    EFS FILE SYSTEM                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                        EFS: pharma-efs-dev                                             │    │
│  │  • Performance Mode: generalPurpose                                                   │    │
│  │  • Throughput Mode: provisioned (100 MiB/s)                                           │    │
│  │  • Mount Path: /mnt/efs                                                               │    │
│  │  • RAG Output Directory: /mnt/efs/rag_output                                          │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    S3 BUCKET                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                        S3: pharma-deployments-864899869769                             │    │
│  │  • Lambda Packages: lambda-packages/                                                  │    │
│  │  • CloudFormation Templates: cloudformation-templates/                                │    │
│  │  • Document Storage: test-documents/                                                  │    │
│  │                                                                                       │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                    S3 EVENT NOTIFICATION                                  │    │    │
│  │  │  • Event: s3:ObjectCreated:*                                              │    │    │
│  │  │  • Filter: *.pdf files only                                               │    │    │
│  │  │  • Target: Document Processor Lambda                                     │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            │
                                            │ S3 Event
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              DOCUMENT PROCESSOR LAMBDA                                        │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                        document_processor.py                                           │    │
│  │  • Triggered by S3 events                                                             │    │
│  │  • Extracts document key from S3 event                                                 │    │
│  │  • Starts ECS task for processing                                                      │    │
│  │  • Calls ALB endpoint: http://{ALB_ENDPOINT}/process                                    │    │
│  │  • Stops task after processing                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    VPC NETWORKING                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                        VPC: pharma-vpc-dev                                             │    │
│  │  • CIDR: 10.0.0.0/16                                                                   │    │
│  │                                                                                       │    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │    │
│  │  │ Public Subnet 1│  │ Public Subnet 2│  │ Private Subnet 1│  │ Private Subnet 2│    │    │
│  │  │ 10.0.1.0/24    │  │ 10.0.2.0/24    │  │ 10.0.3.0/24    │  │ 10.0.4.0/24    │    │    │
│  │  │                 │  │                 │  │                 │  │                 │    │    │
│  │  │ • ALB           │  │ • ALB           │  │ • EFS Mount     │  │ • EFS Mount     │    │    │
│  │  │ • Lambda        │  │ • Lambda        │  │   Target 1      │  │   Target 2      │    │    │
│  │  │ • ECS Tasks     │  │ • ECS Tasks     │  │                 │  │                 │    │    │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    SECURITY GROUPS                                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │ ALB Security    │  │ ECS Security    │  │ Lambda Security │  │ EFS Security    │            │
│  │ Group           │  │ Group           │  │ Group           │  │ Group           │            │
│  │                 │  │                 │  │                 │  │                 │            │
│  │ Inbound:        │  │ Inbound:        │  │ Inbound:        │  │ Inbound:        │            │
│  │ • 80/443 from   │  │ • 8000 from ALB │  │ • None          │  │ • 2049 from ECS │            │
│  │   anywhere      │  │ • 8000 from     │  │                 │  │                 │            │
│  │                 │  │   Lambda        │  │ Outbound:       │  │ Outbound:       │            │
│  │ Outbound:       │  │ • 22 from       │  │ • All traffic   │  │ • All traffic   │            │
│  │ • All traffic   │  │   anywhere      │  │                 │  │                 │            │
│  │                 │  │                 │  │                 │  │                 │            │
│  │ Outbound:       │  │ Outbound:       │  │                 │  │                 │            │
│  │ • All traffic   │  │ • All traffic   │  │                 │  │                 │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

# REQUEST FLOW DIAGRAMS
# =====================

# 1. FILE UPLOAD & PROCESSING FLOW
# ================================

Client ──────────────────────────────────────────────────────────────────────────────────────────┐
  │                                                                                              │
  │ 1. GET /presigned-url                                                                        │
  │    ──────────────────────────────────────────────────────────────────────────────────────┐ │
  │                                                                                            │ │
  │    API Gateway ──────────────────────────────────────────────────────────────────────────┐ │ │
  │      │                                                                                    │ │ │
  │      │ Lambda Invoke                                                                      │ │ │
  │      ▼                                                                                    │ │ │
  │    presigned_url.py ─────────────────────────────────────────────────────────────────────┐ │ │
  │      │                                                                                    │ │ │
  │      │ Generate S3 presigned URL                                                          │ │ │
  │      ▼                                                                                    │ │ │
  │    S3 Bucket ────────────────────────────────────────────────────────────────────────────┐ │ │
  │      │                                                                                    │ │ │
  │      │ Return presigned URL                                                               │ │ │
  │      ▼                                                                                    │ │ │
  │    Client receives presigned URL                                                          │ │ │
  │                                                                                            │ │
  │ 2. PUT to S3 (using presigned URL)                                                        │ │
  │    ──────────────────────────────────────────────────────────────────────────────────────┘ │
  │                                                                                              │
  │    S3 Bucket ──────────────────────────────────────────────────────────────────────────────┐ │
  │      │                                                                                    │ │
  │      │ File uploaded successfully                                                          │ │
  │      │                                                                                    │ │
  │      │ S3 Event: s3:ObjectCreated:*                                                       │ │
  │      │ Filter: *.pdf files only                                                           │ │
  │      ▼                                                                                    │ │
  │    document_processor.py ─────────────────────────────────────────────────────────────────┐ │
  │      │                                                                                    │ │
  │      │ Extract document key from S3 event                                                 │ │
  │      │                                                                                    │ │
  │      │ Start ECS task                                                                     │ │
  │      │                                                                                    │ │
  │      │ Wait for task to be healthy                                                       │ │
  │      │                                                                                    │ │
  │      │ HTTP POST to ALB: http://{ALB_ENDPOINT}/process                                    │ │
  │      │                                                                                    │ │
  │      │ ALB ─────────────────────────────────────────────────────────────────────────────┐ │ │
  │      │   │                                                                              │ │ │
  │      │   │ Forward to healthy ECS task                                                 │ │ │
  │      │   ▼                                                                              │ │ │
  │      │ ECS Task (RAG-Anything) ────────────────────────────────────────────────────────┐ │ │ │
  │      │   │                                                                              │ │ │ │
  │      │   │ Process document                                                             │ │ │ │
  │      │   │                                                                              │ │ │ │
  │      │   │ Store results in EFS                                                         │ │ │ │
  │      │   ▼                                                                              │ │ │ │
  │      │ Return processing result                                                          │ │ │ │
  │      │                                                                                  │ │ │
  │      │ Lambda stops ECS task to save costs                                              │ │ │
  │      │                                                                                  │ │
  │      │ Document processing completed                                                    │ │
  │      └──────────────────────────────────────────────────────────────────────────────────┘ │
  └──────────────────────────────────────────────────────────────────────────────────────────────┘

# 2. RAG QUERY FLOW
# =================

Client ──────────────────────────────────────────────────────────────────────────────────────────┐
  │                                                                                              │
  │ POST /rag-query (or /rag-query-multimodal)                                                  │
  │ ──────────────────────────────────────────────────────────────────────────────────────────┐ │
  │                                                                                            │ │
  │ API Gateway ─────────────────────────────────────────────────────────────────────────────┐ │ │
  │   │                                                                                      │ │ │
  │   │ Lambda Invoke                                                                        │ │ │
  │   ▼                                                                                      │ │ │
  │ rag_query.py (or rag_query_multimodal.py) ──────────────────────────────────────────────┐ │ │ │
  │   │                                                                                      │ │ │ │
  │   │ Check for existing running ECS tasks                                                 │ │ │ │
  │   │                                                                                      │ │ │ │
  │   │ If no running task:                                                                  │ │ │ │
  │   │   • Start new ECS task                                                               │ │ │ │
  │   │   • Wait for task to be RUNNING                                                     │ │ │ │
  │   │                                                                                      │ │ │ │
  │   │ Wait 30 seconds for ALB health check                                                │ │ │ │
  │   │                                                                                      │ │ │ │
  │   │ HTTP POST to ALB: http://{ALB_ENDPOINT}/query                                       │ │ │ │
  │   │                                                                                      │ │ │ │
  │   │ ALB ───────────────────────────────────────────────────────────────────────────────┐ │ │ │ │
  │   │   │                                                                                │ │ │ │ │
  │   │   │ Forward to healthy ECS task                                                   │ │ │ │ │
  │   │   ▼                                                                                │ │ │ │ │
  │   │ ECS Task (RAG-Anything) ──────────────────────────────────────────────────────────┐ │ │ │ │ │
  │   │   │                                                                                │ │ │ │ │ │
  │   │   │ Process RAG query                                                               │ │ │ │ │ │
  │   │   │                                                                                │ │ │ │ │ │
  │   │   │ Query knowledge base (Neo4j)                                                   │ │ │ │ │ │
  │   │   │                                                                                │ │ │ │ │ │
  │   │   │ Generate AI response                                                            │ │ │ │ │ │
  │   │   ▼                                                                                │ │ │ │ │ │
  │   │ Return query result                                                                 │ │ │ │ │ │
  │   │                                                                                    │ │ │ │ │
  │   │ Lambda stops ECS task to save costs                                                │ │ │ │ │
  │   │                                                                                    │ │ │ │
  │   │ Return response to client                                                           │ │ │ │
  │   └──────────────────────────────────────────────────────────────────────────────────┘ │ │ │
  └──────────────────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘

# 3. HEALTH CHECK FLOW
# ====================

Client ──────────────────────────────────────────────────────────────────────────────────────────┐
  │                                                                                              │
  │ GET /health                                                                                  │
  │ ──────────────────────────────────────────────────────────────────────────────────────────┐ │
  │                                                                                            │ │
  │ API Gateway ───────────────────────────────────────────────────────────────────────────────┐ │ │
  │   │                                                                                      │ │ │
  │   │ Lambda Invoke                                                                        │ │ │
  │   ▼                                                                                      │ │ │
  │ health.py ───────────────────────────────────────────────────────────────────────────────┐ │ │ │
  │   │                                                                                      │ │ │ │
  │   │ Query ECS cluster for running tasks                                                  │ │ │ │
  │   │                                                                                      │ │ │ │
  │   │ Return task status and count                                                         │ │ │ │
  │   │                                                                                      │ │ │ │
  │   │ Response:                                                                            │ │ │ │
  │   │ {                                                                                    │ │ │ │
  │   │   "status": "healthy",                                                               │ │ │ │
  │   │   "service": "pharma-rag",                                                           │ │ │ │
  │   │   "ecs_tasks": {                                                                     │ │ │ │
  │   │     "total": 1,                                                                      │ │ │ │
  │   │     "running": 1,                                                                    │ │ │ │
  │   │     "task_arns": ["arn:aws:ecs:..."]                                                │ │ │ │
  │   │   }                                                                                  │ │ │ │
  │   │ }                                                                                    │ │ │ │
  │   └──────────────────────────────────────────────────────────────────────────────────────┘ │ │
  └──────────────────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘

# KEY FEATURES
# ============

✅ ALB automatically handles dynamic ECS task IPs
✅ S3 events trigger document processing automatically  
✅ ECS tasks scale on demand (start with 0, scale up when needed)
✅ Tasks automatically stop after processing to save costs
✅ Health checks ensure only healthy tasks receive traffic
✅ EFS provides persistent storage for RAG outputs
✅ VPC provides secure network isolation
✅ Security groups control traffic flow between components
✅ CloudFormation manages all infrastructure as code

# COST OPTIMIZATION
# =================

• ECS tasks start with DesiredCount: 0
• Tasks only run when processing requests
• Tasks automatically stop after processing
• ALB provides efficient connection pooling
• FARGATE SPOT can be used for additional savings
